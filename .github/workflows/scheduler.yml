name: Public Data Scheduler

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 3ì‹œ (KST) ì‹¤í–‰
    # UTC ê¸°ì¤€ìœ¼ë¡œëŠ” ì˜¤ì „ 3ì‹œ - 9ì‹œê°„ = ì „ë‚  18ì‹œ (6 PM UTC)
    # ì°¸ê³ : GitHub ActionsëŠ” ìµœëŒ€ 1ë¶„ì˜ ì§€ì—°ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
    - cron: '0 18 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: read
  actions: read

jobs:
  trigger-scheduler:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ”” ìŠ¤ì¼€ì¤„ëŸ¬ API í˜¸ì¶œ
        run: |
          API_URL="${{ secrets.SCHEDULER_API_URL || 'https://api.by-zip.com/api/scheduler/public-data' }}"
          API_KEY="${{ secrets.SCHEDULER_API_KEY }}"
          
          if [ -z "$API_KEY" ]; then
            echo "âŒ SCHEDULER_API_KEY ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "ğŸ“¡ ìŠ¤ì¼€ì¤„ëŸ¬ API í˜¸ì¶œ ì¤‘..."
          echo "URL: $API_URL"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $API_KEY" \
            "$API_URL")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "ğŸ“Š ì‘ë‹µ ì½”ë“œ: $HTTP_CODE"
          echo "ğŸ“„ ì‘ë‹µ ë‚´ìš©:"
          echo "$BODY" | jq '.' || echo "$BODY"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # ì‘ë‹µì—ì„œ success í™•ì¸
          SUCCESS=$(echo "$BODY" | jq -r '.success // false')
          if [ "$SUCCESS" != "true" ]; then
            echo "âš ï¸ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"
            echo "$BODY" | jq '.results // []' || echo "ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          echo "âœ… ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì„±ê³µ"
          echo "$BODY" | jq '.results // []' || echo "ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"

